name: Multi-Arch Build

on:
  schedule:
    - cron: '0 3 * * *' # Runs every day at 03:00 UTC
  workflow_dispatch: # Allows manual triggering

jobs:
  build-publish:
    # Display name of the job
    name: Build for ${{ matrix.snap_arch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # Configuration for x86_64
          - snap_arch: amd64
            file_arch: x86_64
          # Configuration for ARM64 (aarch64)
          - snap_arch: arm64
            file_arch: arm64

    steps:
    - uses: actions/checkout@v4

    # 1. Fetch the latest version number
    - name: Check Latest Version
      id: check
      run: |
        LATEST_TAG=$(curl -s https://api.github.com/repos/imputnet/helium-linux/releases/latest | jq -r .tag_name)
        VERSION=${LATEST_TAG#v} 
        echo "Latest version: $VERSION"
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    # 2. Configure snapcraft.yaml for the specific architecture
    - name: Configure snapcraft.yaml
      run: |
        VER="${{ steps.check.outputs.version }}"
        ARCH="${{ matrix.snap_arch }}"
        FILE="${{ matrix.file_arch }}"
        
        echo "Configuring -> Version: $VER, Platform: $ARCH"

        # Update the version line
        sed -i "s/version: .*/version: '$VER'/" snap/snapcraft.yaml
        
        # --- PLATFORM CONFIGURATION ---
        # Crucial for building ARM on GitHub Actions (which are x86).
        # We tell Snapcraft: "Run on amd64, but build for [target_arch]"
        
        sed -i "/confinement: strict/a platforms:\n  $ARCH:\n    build-on: [amd64]\n    build-for: [$ARCH]" snap/snapcraft.yaml
        
        # Update the source URL to match the architecture (x86_64 or arm64)
        LINK="https://github.com/imputnet/helium-linux/releases/download/v$VER/helium-$VER-${FILE}_linux.tar.xz"
        sed -i "s|source: .*|source: $LINK|" snap/snapcraft.yaml
        
        # Debug: Show the file content
        cat snap/snapcraft.yaml

    # 3. Build the Snap package
    - name: Build Snap
      uses: snapcore/action-build@v1
      id: build
      with:
        snapcraft-args: pack

    # 4. Publish to Snap Store
    - name: Publish to Snap Store
      uses: snapcore/action-publish@v1
      env:
        SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.SNAPCRAFT_STORE_CREDENTIALS }}
      with:
        snap: ${{ steps.build.outputs.snap }}
        release: stable